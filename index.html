<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Thinking | Ultimate Neural Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-pink: #ff007a;
            --neon-blue: #00d4ff;
            --neon-green: #39ff14;
            --neon-purple: #9d00ff;
            --neon-yellow: #ffcc00;
            --neon-red: #ff0033;
            --neon-orange: #ff7700;
            --bg-black: #020205;
            --bg-dark: #0a0a10;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-heavy: rgba(255, 255, 255, 0.03);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Outfit', sans-serif; 
        }

        body {
            background: var(--bg-black);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative;
            font-size: 16px;
        }

        /* Animated Mesh Gradient Background */
        .bg-animate {
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(255, 0, 122, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 212, 255, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(157, 0, 255, 0.15) 0%, transparent 50%),
                linear-gradient(180deg, rgba(2,2,5,0.9) 0%, rgba(2,2,5,0.7) 100%);
            z-index: -2;
            animation: moveBg 20s infinite alternate ease-in-out;
        }

        @keyframes moveBg { 
            0% { transform: scale(1) rotate(0deg); } 
            33% { transform: scale(1.05) rotate(1deg); }
            66% { transform: scale(1.03) rotate(-1deg); }
            100% { transform: scale(1.1) rotate(0deg); } 
        }

        /* Grid Overlay */
        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
            opacity: 0.3;
        }

        /* --- Header --- */
        header {
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(30px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo-area { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .brand { 
            font-size: 1.8rem; 
            font-weight: 800; 
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-pink)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            letter-spacing: 1px;
            text-shadow: 0 0 20px rgba(255, 0, 122, 0.5);
        }

        /* Status System */
        .status-system {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .reactor-box {
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: var(--glass);
            padding: 8px 16px; 
            border-radius: 50px; 
            border: 1px solid var(--glass-border);
            min-width: 150px;
        }
        
        .reactor-core { 
            width: 14px; 
            height: 14px; 
            border-radius: 50%; 
            transition: all 0.5s ease;
        }
        
        /* Status States */
        .status-online { 
            background: var(--neon-green); 
            box-shadow: 0 0 25px var(--neon-green); 
            animation: pulse-green 1.5s infinite; 
        }
        
        .status-offline { 
            background: var(--neon-red); 
            box-shadow: 0 0 15px var(--neon-red); 
        }
        
        .status-slow { 
            background: var(--neon-yellow); 
            box-shadow: 0 0 20px var(--neon-yellow); 
            animation: pulse-yellow 1.2s infinite; 
        }
        
        .status-thinking { 
            background: var(--neon-blue); 
            box-shadow: 0 0 25px var(--neon-blue); 
            animation: thinking-pulse 0.8s infinite alternate; 
        }

        @keyframes pulse-green { 
            0% { transform: scale(1); opacity: 1; } 
            50% { transform: scale(1.4); opacity: 0.7; } 
            100% { transform: scale(1); opacity: 1; } 
        }
        
        @keyframes pulse-yellow { 
            0% { transform: scale(1); opacity: 1; } 
            50% { transform: scale(1.3); opacity: 0.6; } 
            100% { transform: scale(1); opacity: 1; } 
        }
        
        @keyframes thinking-pulse { 
            0% { transform: scale(1); box-shadow: 0 0 10px var(--neon-blue); } 
            100% { transform: scale(1.2); box-shadow: 0 0 30px var(--neon-blue); } 
        }

        .status-text {
            font-size: 12px; 
            font-weight: 800; 
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.5px;
        }

        .status-online-text { color: var(--neon-green); }
        .status-offline-text { color: var(--neon-red); }
        .status-slow-text { color: var(--neon-yellow); }
        .status-thinking-text { color: var(--neon-blue); }

        /* Header Controls */
        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .circle-btn {
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            border: 1px solid var(--glass-border);
            cursor: pointer; 
            display: grid; 
            place-items: center; 
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            font-size: 1.1rem;
        }
        
        .circle-btn:hover {
            transform: scale(1.1);
            background: var(--glass);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        /* Leaf Icon */
        .leaf-btn {
            color: var(--neon-green);
            font-size: 1.4rem;
            cursor: pointer;
            filter: drop-shadow(0 0 8px var(--neon-green));
            transition: 0.3s;
        }
        
        .leaf-btn:hover { 
            transform: rotate(15deg) scale(1.2); 
            filter: drop-shadow(0 0 15px var(--neon-green));
        }

        /* Global Speaker Control */
        .global-speaker-control {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--glass);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 600;
        }
        
        .global-speaker-control:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--neon-blue);
        }
        
        .global-speaker-control.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--neon-blue);
            color: var(--neon-blue);
        }
        
        .global-speaker-control.active i {
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
        }

        /* --- Project Tabs --- */
        .tabs { 
            padding: 15px; 
            display: flex; 
            gap: 12px; 
            overflow-x: auto;
            background: rgba(0,0,0,0.4);
            border-bottom: 1px solid var(--glass-border);
            min-height: 70px;
            align-items: center;
        }
        
        .tab-item {
            padding: 10px 24px; 
            background: var(--glass); 
            border: 1px solid var(--glass-border);
            border-radius: 20px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            white-space: nowrap; 
            transition: all 0.4s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-item.active { 
            background: linear-gradient(45deg, var(--neon-purple), var(--neon-pink)); 
            border: none; 
            box-shadow: 0 0 20px rgba(255,0,122,0.5); 
            transform: translateY(-2px);
        }

        /* --- Chat Main --- */
        #chat-window { 
            flex: 1; 
            overflow-y: auto; 
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .msg-wrap { 
            display: flex; 
            flex-direction: column; 
            max-width: 85%; 
            animation: msgIn 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
        }
        
        .u-wrap { align-self: flex-end; }
        .a-wrap { align-self: flex-start; }

        @keyframes msgIn { 
            from { opacity: 0; transform: translateY(20px) scale(0.9); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        .bubble {
            padding: 18px 22px; 
            border-radius: 25px; 
            font-size: 16px; 
            line-height: 1.6; 
            position: relative;
            backdrop-filter: blur(10px); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        
        .u-bubble { 
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); 
            border-bottom-right-radius: 4px; 
            color: #fff; 
        }
        
        .a-bubble { 
            background: var(--glass); 
            border: 1px solid var(--glass-border); 
            border-bottom-left-radius: 4px; 
            color: #e0e0e0; 
        }

        .bubble-tools {
            display: flex; 
            gap: 20px; 
            margin-top: 8px; 
            padding: 0 10px; 
            opacity: 0.3; 
            transition: 0.3s; 
            font-size: 12px;
            align-items: center;
        }
        
        .msg-wrap:hover .bubble-tools { opacity: 1; }
        
        .tool-btn { 
            cursor: pointer; 
            color: #aaa; 
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .tool-btn:hover { 
            color: var(--neon-blue); 
            transform: translateY(-2px);
        }
        
        .tool-btn.speak-btn:hover { color: var(--neon-green); }
        .tool-btn.speak-btn.active { color: var(--neon-green); }
        .tool-btn.speak-btn.active i { text-shadow: 0 0 8px var(--neon-green); }
        .tool-btn.speak-btn.muted { color: var(--neon-red); }
        .tool-btn.delete-btn:hover { color: var(--neon-red); }

        /* Thinking Indicator in Chat */
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            margin-left: 10px;
            color: var(--neon-blue);
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--neon-blue);
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.3; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* --- Floating Input --- */
        .input-container { 
            padding: 20px 25px; 
            background: transparent; 
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .input-bar {
            background: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(25px); 
            border: 1px solid var(--glass-border);
            border-radius: 100px; 
            padding: 10px 15px 10px 25px; 
            display: flex; 
            align-items: center; 
            gap: 15px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.6);
            transition: all 0.3s;
        }
        
        .input-bar:focus-within {
            border-color: var(--neon-blue);
            box-shadow: 0 15px 50px rgba(0, 212, 255, 0.2);
        }
        
        textarea { 
            flex: 1; 
            background: transparent; 
            border: none; 
            outline: none; 
            color: #fff; 
            font-size: 16px; 
            resize: none; 
            max-height: 150px; 
            line-height: 1.5;
            font-family: 'Outfit', sans-serif;
            padding: 10px 0;
        }
        
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .input-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .color-picker {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .color-picker:hover {
            transform: scale(1.1);
            border-color: var(--neon-blue);
        }
        
        .color-picker input {
            width: 100%;
            height: 100%;
            border: none;
            cursor: pointer;
            background: transparent;
        }
        
        .mic-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #aaa;
            border: 1px solid transparent;
        }
        
        .mic-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .mic-btn.listening {
            background: rgba(255, 0, 51, 0.2);
            color: var(--neon-red);
            border-color: var(--neon-red);
            animation: pulse-red 1s infinite;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 51, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 51, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 51, 0); }
        }
        
        .send-btn { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            border: none; 
            cursor: pointer; 
            display: grid; 
            place-items: center; 
            transition: all 0.3s; 
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            color: #fff;
            font-size: 1.3rem;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        .send-btn:hover { 
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 0, 122, 0.4);
        }

        /* --- Overlays --- */
        .overlay {
            position: fixed; 
            inset: 0; 
            background: rgba(2,2,5,0.98); 
            backdrop-filter: blur(40px);
            z-index: 1000; 
            display: none; 
            padding: 35px 25px; 
            overflow-y: auto;
        }
        
        .overlay.active { 
            display: block; 
            animation: fade 0.3s ease; 
        }
        
        @keyframes fade { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }

        .overlay-content {
            max-width: 800px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .overlay-title {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }

        .neon-card {
            background: var(--glass); 
            padding: 30px; 
            border-radius: 25px; 
            border: 1px solid var(--glass-border); 
            margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        input, textarea.f-input, select {
            width: 100%; 
            background: rgba(0,0,0,0.5); 
            border: 1px solid var(--glass-border); 
            padding: 18px 20px;
            border-radius: 15px; 
            color: #fff; 
            margin: 10px 0; 
            outline: none;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, textarea.f-input:focus, select:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }
        
        .btn-glow {
            width: 100%; 
            padding: 18px; 
            border-radius: 15px; 
            border: none; 
            font-weight: 800; 
            font-size: 1.1rem;
            cursor: pointer; 
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-pink)); 
            color: #fff; 
            margin-top: 10px;
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }
        
        .btn-glow:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 0, 122, 0.3);
        }

        /* --- Guide Styles --- */
        .guide-step { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 25px; 
            align-items: flex-start; 
        }
        
        .step-num { 
            width: 40px; 
            height: 40px; 
            background: var(--neon-green); 
            color: #000; 
            border-radius: 50%; 
            display: grid; 
            place-items: center; 
            font-weight: 900; 
            flex-shrink: 0; 
            font-size: 1.2rem;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content h3 {
            color: var(--neon-green);
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        /* Personal API Display */
        .user-id-box {
            background: rgba(0, 0, 0, 0.5); 
            border: 1px dashed var(--neon-blue); 
            padding: 20px; 
            border-radius: 12px;
            text-align: center; 
            font-family: 'JetBrains Mono', monospace; 
            color: var(--neon-blue); 
            font-size: 1.2rem; 
            margin: 15px 0;
            word-break: break-all;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.1);
        }

        /* Project List */
        .project-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }
        
        .project-card:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
            border-color: var(--neon-blue);
        }
        
        .project-info h3 {
            margin-bottom: 5px;
            color: #fff;
        }
        
        .project-info p {
            color: #aaa;
            font-size: 14px;
        }
        
        .project-actions {
            display: flex;
            gap: 15px;
        }

        /* Status Lights */
        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        /* Footer */
        footer {
            padding: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            border-top: 1px solid var(--glass-border);
            margin-top: auto;
        }

        /* Custom Notification */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 212, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--neon-blue);
            border-radius: 15px;
            padding: 15px 25px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            z-index: 10000;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                padding: 12px 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .status-system {
                width: 100%;
                justify-content: space-between;
            }
            
            .header-controls {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }
            
            .brand {
                font-size: 1.5rem;
            }
            
            .tabs {
                padding: 12px 15px;
                gap: 8px;
            }
            
            .tab-item {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            #chat-window {
                padding: 15px;
                gap: 20px;
            }
            
            .msg-wrap {
                max-width: 95%;
            }
            
            .bubble {
                padding: 15px 18px;
                font-size: 15px;
            }
            
            .input-container {
                padding: 15px;
            }
            
            .input-bar {
                padding: 8px 12px 8px 18px;
            }
            
            .overlay {
                padding: 25px 15px;
            }
            
            .overlay-title {
                font-size: 1.8rem;
            }
            
            .neon-card {
                padding: 20px;
            }
            
            .step-num {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .guide-step {
                gap: 15px;
            }
            
            .global-speaker-control {
                font-size: 10px;
                padding: 5px 8px;
            }
            
            .project-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .project-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        @media (max-width: 480px) {
            .reactor-box {
                min-width: 130px;
            }
            
            .circle-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .send-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .mic-btn {
                width: 40px;
                height: 40px;
            }
            
            .msg-wrap {
                max-width: 100%;
            }
            
            .bubble-tools {
                flex-wrap: wrap;
                gap: 10px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { 
            width: 8px; 
            height: 8px;
        }
        
        ::-webkit-scrollbar-track { 
            background: rgba(0, 0, 0, 0.2); 
            border-radius: 10px; 
        }
        
        ::-webkit-scrollbar-thumb { 
            background: var(--glass-border); 
            border-radius: 10px; 
        }
        
        ::-webkit-scrollbar-thumb:hover { 
            background: var(--neon-blue); 
        }

        /* Voice Wave Animation */
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }
        
        .voice-wave span {
            display: inline-block;
            width: 3px;
            border-radius: 3px;
            background: var(--neon-red);
            animation: voiceWave 1.2s infinite ease-in-out;
        }
        
        .voice-wave span:nth-child(1) { height: 6px; animation-delay: 0s; }
        .voice-wave span:nth-child(2) { height: 10px; animation-delay: 0.2s; }
        .voice-wave span:nth-child(3) { height: 14px; animation-delay: 0.4s; }
        .voice-wave span:nth-child(4) { height: 10px; animation-delay: 0.6s; }
        .voice-wave span:nth-child(5) { height: 6px; animation-delay: 0.8s; }
        
        @keyframes voiceWave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }
        
        /* Speaker Status Animation */
        .speaker-active {
            color: var(--neon-green) !important;
            text-shadow: 0 0 8px var(--neon-green);
            animation: pulse-speaker 1.5s infinite;
        }
        
        @keyframes pulse-speaker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Loading Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body onload="init()">

    <div class="bg-animate"></div>
    <div class="grid-overlay"></div>

    <header>
        <div class="logo-area">
            <i class="fas fa-leaf leaf-btn" onclick="openOverlay('help-overlay')" title="How to use?"></i>
            <div class="brand">AI Thinking</div>
        </div>
        
        <div class="status-system">
            <div class="reactor-box">
                <div id="orb" class="reactor-core status-offline"></div>
                <span id="status-label" class="status-text status-offline-text">OFFLINE</span>
            </div>
            
            <div id="thinking-light" class="reactor-box" style="display: none;">
                <div class="reactor-core status-thinking"></div>
                <span class="status-text status-thinking-text">THINKING</span>
            </div>
            
            <div id="response-light" class="reactor-box" style="display: none;">
                <div class="reactor-core" style="background: var(--neon-blue); box-shadow: 0 0 20px var(--neon-blue);"></div>
                <span class="status-text" style="color: var(--neon-blue);">RESPONDING</span>
            </div>
            
            <!-- Global Speaker Control -->
            <div class="global-speaker-control" id="global-speaker-control" onclick="toggleGlobalSpeaker()">
                <i class="fas fa-volume-up"></i>
                <span>Speaker: ON</span>
            </div>
        </div>
        
        <div class="header-controls">
            <i class="fas fa-plus circle-btn" onclick="openOverlay('project-overlay')" title="New Project"></i>
            <i class="fas fa-fingerprint circle-btn" onclick="openOverlay('settings-overlay')" title="Settings"></i>
        </div>
    </header>

    <div class="tabs" id="project-tabs"></div>

    <main id="chat-window"></main>

    <div class="input-container">
        <div class="input-bar">
            <div class="color-picker">
                <input type="color" id="user-color" value="#00d4ff" title="Choose your message color">
            </div>
            
            <div class="mic-btn" id="mic-btn" onclick="startSpeech()" title="Voice Input">
                <i class="fas fa-microphone"></i>
            </div>
            
            <textarea id="user-input" placeholder="Start thinking..." rows="1"></textarea>
            
            <div class="input-controls">
                <button class="send-btn" onclick="handleSend()" id="send-btn" title="Send Message">
                    <i class="fas fa-bolt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Help Overlay -->
    <div class="overlay" id="help-overlay">
        <div class="overlay-content">
            <div class="overlay-header">
                <h1 class="overlay-title">üåø GUIDE: HOW TO USE</h1>
                <i class="fas fa-times circle-btn" onclick="closeAll()"></i>
            </div>
            
            <div class="neon-card">
                <div class="guide-step">
                    <div class="step-num">1</div>
                    <div class="step-content">
                        <h3>Setup API Key</h3>
                        <p>Click the Fingerprint icon and paste your OpenRouter API Key. This activates the AI brain. Status lights will show connection state.</p>
                    </div>
                </div>
                
                <div class="guide-step">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        <h3>Create Project</h3>
                        <p>Click the (+) icon to create a project like "Home Teacher" or "Fitness Coach". Each project has its own memory and persona.</p>
                    </div>
                </div>
                
                <div class="guide-step">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        <h3>Self-Learning</h3>
                        <p>Just talk! The AI automatically learns your preferences and updates its internal brain for that project. Blue light shows when AI is thinking.</p>
                    </div>
                </div>
                
                <div class="guide-step">
                    <div class="step-num">4</div>
                    <div class="step-content">
                        <h3>Voice & Actions</h3>
                        <p>Use the Mic to speak. Click the speaker icon on AI messages to hear responses. Click again to stop. Global speaker control in header.</p>
                    </div>
                </div>
            </div>
            
            <button class="btn-glow" style="background: var(--neon-green); color:#000;" onclick="closeAll()">
                <i class="fas fa-check"></i> GOT IT!
            </button>
        </div>
    </div>

    <!-- Project Hub -->
    <div class="overlay" id="project-overlay">
        <div class="overlay-content">
            <div class="overlay-header">
                <h1 class="overlay-title">NEW PROJECT</h1>
                <i class="fas fa-times circle-btn" onclick="closeAll()"></i>
            </div>
            
            <div class="neon-card">
                <input type="text" id="new-name" placeholder="Project Title (e.g. My Smart Assistant)">
                <input type="text" id="new-persona" placeholder="Persona (Who should the AI be?)">
                <textarea class="f-input" id="new-rules" placeholder="Core Instructions/Rules..." rows="3"></textarea>
                <button class="btn-glow" onclick="addProject()">
                    <i class="fas fa-rocket"></i> LAUNCH PROJECT
                </button>
            </div>
            
            <div id="project-list-render">
                <!-- Projects will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Settings & Personal API -->
    <div class="overlay" id="settings-overlay">
        <div class="overlay-content">
            <div class="overlay-header">
                <h1 class="overlay-title">IDENTITY & CONFIG</h1>
                <i class="fas fa-times circle-btn" onclick="closeAll()"></i>
            </div>
            
            <div class="neon-card">
                <h3 style="color: var(--neon-blue); margin-bottom: 15px;">
                    <i class="fas fa-user-circle"></i> Your Personal User Key
                </h3>
                <p style="font-size: 14px; color: #aaa; margin-bottom: 15px;">
                    This key uniquely identifies you and your trained projects across all devices.
                </p>
                <div class="user-id-box" id="user-key-display">AIT-LOADING...</div>
                <button class="btn-glow" style="background: #222; font-size: 14px;" onclick="generateNewUserKey()">
                    <i class="fas fa-key"></i> GENERATE NEW UNIQUE KEY
                </button>
            </div>

            <div class="neon-card">
                <h3 style="color: var(--neon-pink); margin-bottom: 15px;">
                    <i class="fas fa-cogs"></i> System API Settings
                </h3>
                <input type="password" id="api-key" placeholder="OpenRouter API Key (sk-or-...)" value="">
                
                <select id="model-select" onchange="updateModelInput()">
                    <option value="">-- Choose Model --</option>
                    <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Free)</option>
                    <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (Free)</option>
                    <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (Free)</option>
                    <option value="gryphe/mythomax-l2-13b">MythoMax L2 13B</option>
                    <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="openai/gpt-4">GPT-4</option>
                    <option value="custom">Custom Model</option>
                </select>
                
                <input type="text" id="model-id" placeholder="Model ID (e.g., google/gemini-2.0-flash-exp:free)">
                
                <div style="margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                    <h4 style="color: var(--neon-green); margin-bottom: 10px;">Voice Settings</h4>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="auto-speak" checked>
                                <span>Auto-speak AI responses</span>
                            </label>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="mute-all" onclick="toggleMuteAll()">
                                <span>Mute all speakers</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <button class="btn-glow" onclick="saveSettings()">
                    <i class="fas fa-save"></i> SAVE SYSTEM CONFIG
                </button>
            </div>
            
            <button class="btn-glow" style="background: linear-gradient(45deg, #ff0033, #ff6600); margin-top: 20px;" onclick="if(confirm('This will delete ALL data. Continue?')) { localStorage.clear(); location.reload(); }">
                <i class="fas fa-bomb"></i> DESTROY ALL DATA
            </button>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="snd-beep" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="snd-speech" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <footer>
        <p>AI Thinking Hub v2.0 | Neural Interface Active | Status: <span id="footer-status">Loading...</span></p>
    </footer>

    <script>
        // Main Database
        let db = JSON.parse(localStorage.getItem('ai_thinking_ultimate')) || {
            apiKey: '',
            userKey: 'AIT-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
            model: 'google/gemini-2.0-flash-exp:free',
            activeId: 'p1',
            speakerEnabled: true,
            autoSpeak: true,
            projects: {
                'p1': { 
                    name: 'Universal Brain', 
                    persona: 'Helpful AI assistant', 
                    rules: 'Be very smart and helpful', 
                    memory: '', 
                    messages: [],
                    created: new Date().toISOString()
                }
            }
        };

        // Speech Recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
        }

        // Global Variables for Speaker Control
        let isThinking = false;
        let apiResponseTime = 0;
        let currentSpeech = {
            utterance: null,
            speakingIndex: null,
            isSpeaking: false
        };
        let speechQueue = [];
        let isSpeechMuted = false;

        // Initialize App
        function init() {
            renderTabs();
            renderMessages();
            checkApiStatus();
            document.getElementById('user-key-display').innerText = db.userKey;
            setupInput();
            
            // Initialize global speaker control
            updateGlobalSpeakerControl();
            
            // Load API key if exists
            if (db.apiKey) {
                document.getElementById('api-key').value = db.apiKey;
            }
            
            // Load model settings
            if (db.model) {
                document.getElementById('model-id').value = db.model;
                loadModelSettings();
            }
            
            // Load voice settings
            if (db.autoSpeak !== undefined) {
                document.getElementById('auto-speak').checked = db.autoSpeak;
            }
            
            // Update footer status
            updateFooterStatus();
        }

        function save() { 
            localStorage.setItem('ai_thinking_ultimate', JSON.stringify(db)); 
        }

        // Update Footer Status
        function updateFooterStatus() {
            const footer = document.getElementById('footer-status');
            if (db.apiKey) {
                footer.innerHTML = `<span style="color: var(--neon-green);">‚óè ONLINE</span>`;
            } else {
                footer.innerHTML = `<span style="color: var(--neon-red);">‚óè OFFLINE</span>`;
            }
        }

        // --- API Status Monitoring ---
        async function checkApiStatus() {
            const orb = document.getElementById('orb');
            const label = document.getElementById('status-label');
            
            if (!db.apiKey) {
                orb.className = 'reactor-core status-offline';
                label.className = 'status-text status-offline-text';
                label.innerText = "OFFLINE";
                updateFooterStatus();
                return;
            }
            
            // Start timing
            const startTime = Date.now();
            
            try {
                // Simple test request
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${db.apiKey}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({
                        "model": db.model,
                        "messages": [{ role: "user", content: "test" }],
                        "max_tokens": 5
                    })
                });
                
                apiResponseTime = Date.now() - startTime;
                
                if (response.ok) {
                    if (apiResponseTime < 2000) {
                        // Fast response
                        orb.className = 'reactor-core status-online';
                        label.className = 'status-text status-online-text';
                        label.innerText = `READY (${apiResponseTime}ms)`;
                    } else {
                        // Slow response
                        orb.className = 'reactor-core status-slow';
                        label.className = 'status-text status-slow-text';
                        label.innerText = `SLOW (${apiResponseTime}ms)`;
                    }
                } else {
                    orb.className = 'reactor-core status-offline';
                    label.className = 'status-text status-offline-text';
                    label.innerText = "API ERROR";
                }
            } catch (error) {
                orb.className = 'reactor-core status-offline';
                label.className = 'status-text status-offline-text';
                label.innerText = "OFFLINE";
                apiResponseTime = 0;
            }
            
            updateFooterStatus();
        }

        // --- Global Speaker Control ---
        function toggleGlobalSpeaker() {
            db.speakerEnabled = !db.speakerEnabled;
            save();
            updateGlobalSpeakerControl();
            
            // If turning off, stop any current speech
            if (!db.speakerEnabled && currentSpeech.isSpeaking) {
                stopAllSpeech();
            }
            
            // Play feedback sound
            playSound('beep');
            
            // Show notification
            showNotification(`Speaker ${db.speakerEnabled ? 'ON' : 'OFF'}`);
        }

        function updateGlobalSpeakerControl() {
            const control = document.getElementById('global-speaker-control');
            const icon = control.querySelector('i');
            const text = control.querySelector('span');
            
            if (db.speakerEnabled) {
                control.classList.add('active');
                icon.className = 'fas fa-volume-up';
                text.textContent = 'Speaker: ON';
            } else {
                control.classList.remove('active');
                icon.className = 'fas fa-volume-mute';
                text.textContent = 'Speaker: OFF';
            }
        }

        function toggleMuteAll() {
            const muteCheckbox = document.getElementById('mute-all');
            isSpeechMuted = muteCheckbox.checked;
            
            if (isSpeechMuted && currentSpeech.isSpeaking) {
                stopAllSpeech();
            }
            
            showNotification(isSpeechMuted ? 'All speakers muted' : 'Speakers unmuted');
        }

        // --- Core Logic ---
        function renderTabs() {
            const tabs = document.getElementById('project-tabs');
            tabs.innerHTML = '';
            
            for (let id in db.projects) {
                const item = document.createElement('div');
                item.className = `tab-item ${db.activeId === id ? 'active' : ''}`;
                item.innerText = db.projects[id].name;
                item.onclick = () => { 
                    db.activeId = id; 
                    save(); 
                    init(); 
                };
                tabs.appendChild(item);
            }
        }

        function renderMessages() {
            const win = document.getElementById('chat-window');
            win.innerHTML = '';
            
            // Add welcome message if empty
            if (db.projects[db.activeId].messages.length === 0) {
                const welcomeWrap = document.createElement('div');
                welcomeWrap.className = 'msg-wrap a-wrap';
                welcomeWrap.innerHTML = `
                    <div class="bubble a-bubble">
                        <h3 style="color: var(--neon-blue); margin-bottom: 10px;">ü§ñ Welcome to AI Thinking Hub!</h3>
                        <p>I'm your AI assistant. Start by typing a message or use voice input.</p>
                        <p style="margin-top: 10px; font-size: 14px; color: #aaa;">
                            <i class="fas fa-lightbulb"></i> Tip: Click the speaker icon to hear responses. Click again to stop.
                        </p>
                    </div>
                `;
                win.appendChild(welcomeWrap);
            }
            
            // Render messages
            db.projects[db.activeId].messages.forEach((m, idx) => {
                const wrap = document.createElement('div');
                wrap.className = `msg-wrap ${m.role === 'user' ? 'u-wrap' : 'a-wrap'}`;
                
                let bubbleStyle = '';
                if (m.role === 'user' && m.color) {
                    bubbleStyle = `background: linear-gradient(135deg, ${m.color}, ${adjustColor(m.color, -30)});`;
                }
                
                // Determine speaker button state
                let speakerBtnClass = 'speak-btn';
                let speakerIcon = 'fa-volume-up';
                let speakerText = 'Speak';
                
                if (currentSpeech.speakingIndex === idx && currentSpeech.isSpeaking) {
                    speakerBtnClass += ' active';
                    speakerIcon = 'fa-stop';
                    speakerText = 'Stop';
                } else if (m.speakerMuted || isSpeechMuted) {
                    speakerBtnClass += ' muted';
                    speakerIcon = 'fa-volume-mute';
                    speakerText = 'Muted';
                }
                
                wrap.innerHTML = `
                    <div class="bubble ${m.role === 'user' ? 'u-bubble' : 'a-bubble'}" style="${bubbleStyle}">
                        ${m.content}
                    </div>
                    <div class="bubble-tools">
                        ${m.role === 'ai' ? 
                            `<span class="tool-btn ${speakerBtnClass}" onclick="toggleMessageSpeech(${idx})">
                                <i class="fas ${speakerIcon}"></i> ${speakerText}
                            </span>` : ''
                        }
                        <span class="tool-btn" onclick="copyText(${idx})">
                            <i class="fas fa-copy"></i> Copy
                        </span>
                        <span class="tool-btn delete-btn" onclick="deleteMsg(${idx})">
                            <i class="fas fa-trash"></i> Delete
                        </span>
                    </div>
                `;
                win.appendChild(wrap);
            });
            
            win.scrollTop = win.scrollHeight;
        }

        // Helper to adjust color brightness
        function adjustColor(color, amount) {
            let usePound = false;
            if (color[0] === "#") {
                color = color.slice(1);
                usePound = true;
            }
            const num = parseInt(color, 16);
            let r = (num >> 16) + amount;
            if (r > 255) r = 255;
            else if (r < 0) r = 0;
            
            let b = ((num >> 8) & 0x00FF) + amount;
            if (b > 255) b = 255;
            else if (b < 0) b = 0;
            
            let g = (num & 0x0000FF) + amount;
            if (g > 255) g = 255;
            else if (g < 0) g = 0;
            
            return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
        }

        // Main Send Function
        async function handleSend() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const color = document.getElementById('user-color').value;
            const project = db.projects[db.activeId];

            if (!text) return;
            
            // Add user message
            project.messages.push({ role: 'user', content: text, color: color });
            renderMessages();
            input.value = '';
            resetInputHeight();
            
            if (!db.apiKey) {
                // Show offline warning
                const offlineMsg = { role: 'ai', content: '‚ö†Ô∏è API key not configured. Please add your OpenRouter API key in settings to use AI features.' };
                project.messages.push(offlineMsg);
                renderMessages();
                save();
                return;
            }
            
            // Show thinking indicator
            showThinkingIndicator();
            
            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${db.apiKey}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({
                        "model": db.model,
                        "messages": [
                            { 
                                role: "system", 
                                content: `You are: ${project.persona}. Rules: ${project.rules}. 
                                Previous context/memory: ${project.memory}. 
                                Respond naturally and helpfully.`
                            },
                            ...project.messages.slice(-12).map(m => ({
                                role: m.role === 'user' ? 'user' : 'assistant', 
                                content: m.content 
                            }))
                        ]
                    })
                });
                
                // Show response light
                showResponseLight();
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const aiText = data.choices[0].message.content;
                
                // Add AI response
                project.messages.push({ role: 'ai', content: aiText });
                save();
                renderMessages();
                
                // Auto-speak if enabled
                if (db.speakerEnabled && db.autoSpeak && !isSpeechMuted) {
                    // Add to speech queue
                    const msgIndex = project.messages.length - 1;
                    speakMessage(msgIndex);
                }
                
                // Auto-learn from interaction
                autoTrain(text, aiText);
                
                // Update API status
                checkApiStatus();
                
            } catch (error) {
                console.error('API Error:', error);
                const errorMsg = { 
                    role: 'ai', 
                    content: `‚ùå Error: ${error.message}. Please check your API key and network connection.` 
                };
                project.messages.push(errorMsg);
                renderMessages();
                save();
            } finally {
                // Hide indicators
                hideThinkingIndicator();
                hideResponseLight();
            }
        }

        // Thinking Indicator
        function showThinkingIndicator() {
            isThinking = true;
            const indicator = document.getElementById('thinking-light');
            indicator.style.display = 'flex';
            
            // Add thinking message to chat
            const win = document.getElementById('chat-window');
            const thinkingWrap = document.createElement('div');
            thinkingWrap.className = 'msg-wrap a-wrap';
            thinkingWrap.id = 'thinking-indicator';
            thinkingWrap.innerHTML = `
                <div class="bubble a-bubble">
                    <div class="thinking-indicator">
                        <div class="typing-dots">
                            <span></span><span></span><span></span>
                        </div>
                        <span>Thinking...</span>
                    </div>
                </div>
            `;
            win.appendChild(thinkingWrap);
            win.scrollTop = win.scrollHeight;
        }

        function hideThinkingIndicator() {
            isThinking = false;
            document.getElementById('thinking-light').style.display = 'none';
            const indicator = document.getElementById('thinking-indicator');
            if (indicator) indicator.remove();
        }

        function showResponseLight() {
            document.getElementById('response-light').style.display = 'flex';
        }

        function hideResponseLight() {
            document.getElementById('response-light').style.display = 'none';
        }

        // --- Enhanced Speech Functions ---
        function toggleMessageSpeech(idx) {
            // If this message is currently speaking, stop it
            if (currentSpeech.speakingIndex === idx && currentSpeech.isSpeaking) {
                stopSpeech();
                return;
            }
            
            // If another message is speaking, stop it first
            if (currentSpeech.isSpeaking) {
                stopSpeech();
            }
            
            // Start speaking this message
            speakMessage(idx);
        }

        function speakMessage(idx) {
            // Check if speaker is enabled
            if (!db.speakerEnabled || isSpeechMuted) {
                showNotification('Speaker is disabled or muted');
                return;
            }
            
            const text = db.projects[db.activeId].messages[idx].content;
            
            // Stop any current speech
            if (currentSpeech.isSpeaking) {
                stopSpeech();
            }
            
            // Create new utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Set current speech state
            currentSpeech.utterance = utterance;
            currentSpeech.speakingIndex = idx;
            currentSpeech.isSpeaking = true;
            
            // Update UI
            renderMessages();
            
            // Play start sound
            playSound('speech');
            
            // Speak the text
            utterance.onstart = function() {
                showNotification(`Speaking message ${idx + 1}`);
            };
            
            utterance.onend = function() {
                currentSpeech.speakingIndex = null;
                currentSpeech.isSpeaking = false;
                currentSpeech.utterance = null;
                renderMessages();
            };
            
            utterance.onerror = function(event) {
                console.error('Speech synthesis error:', event);
                currentSpeech.speakingIndex = null;
                currentSpeech.isSpeaking = false;
                currentSpeech.utterance = null;
                renderMessages();
                showNotification('Speech error occurred');
            };
            
            window.speechSynthesis.speak(utterance);
        }

        function stopSpeech() {
            if (currentSpeech.isSpeaking && currentSpeech.utterance) {
                window.speechSynthesis.cancel();
                currentSpeech.speakingIndex = null;
                currentSpeech.isSpeaking = false;
                currentSpeech.utterance = null;
                renderMessages();
                showNotification('Speech stopped');
            }
        }

        function stopAllSpeech() {
            window.speechSynthesis.cancel();
            currentSpeech.speakingIndex = null;
            currentSpeech.isSpeaking = false;
            currentSpeech.utterance = null;
            speechQueue = [];
            renderMessages();
        }

        function playSound(type) {
            if (!db.speakerEnabled || isSpeechMuted) return;
            
            const audio = document.getElementById(`snd-${type}`);
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        }

        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.querySelectorAll('.custom-notification');
            existing.forEach(el => el.remove());
            
            const colors = {
                info: { bg: 'rgba(0, 212, 255, 0.9)', border: 'var(--neon-blue)' },
                success: { bg: 'rgba(57, 255, 20, 0.9)', border: 'var(--neon-green)' },
                error: { bg: 'rgba(255, 0, 51, 0.9)', border: 'var(--neon-red)' },
                warning: { bg: 'rgba(255, 204, 0, 0.9)', border: 'var(--neon-yellow)' }
            };
            
            const color = colors[type] || colors.info;
            
            const notification = document.createElement('div');
            notification.className = 'custom-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color.bg};
                backdrop-filter: blur(20px);
                border: 1px solid ${color.border};
                border-radius: 15px;
                padding: 15px 25px;
                color: white;
                font-size: 14px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
                max-width: 350px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Auto-learning Function
        async function autoTrain(userMsg, aiMsg) {
            const project = db.projects[db.activeId];
            
            // Only train if we have enough context
            if (project.messages.length < 3) return;
            
            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${db.apiKey}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({
                        "model": db.model,
                        "messages": [
                            { 
                                role: "system", 
                                content: "Extract 1-2 key learning points from this interaction to remember about the user. Keep it very concise, max 2 sentences." 
                            },
                            { 
                                role: "user", 
                                content: `Current memory: ${project.memory || 'None'}\n\nUser said: "${userMsg}"\nAI responded: "${aiMsg}"\n\nExtract key learning:`
                            }
                        ]
                    })
                });
                
                const data = await res.json();
                const newMemory = data.choices[0].message.content;
                
                // Update memory (keep it concise)
                if (!project.memory) {
                    project.memory = newMemory;
                } else {
                    // Combine and limit memory size
                    const combined = project.memory + ' ' + newMemory;
                    // Limit to ~500 chars
                    project.memory = combined.length > 500 ? 
                        combined.substring(combined.length - 500) : combined;
                }
                
                save();
            } catch(e) {
                console.log('Memory update skipped:', e);
            }
        }

        // --- Voice Input Functions ---
        function startSpeech() {
            if (!recognition) {
                alert('Speech recognition not supported in this browser.');
                return;
            }
            
            const micBtn = document.getElementById('mic-btn');
            micBtn.classList.add('listening');
            micBtn.innerHTML = '<div class="voice-wave"><span></span><span></span><span></span><span></span><span></span></div>';
            
            recognition.start();
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('user-input').value = transcript;
                micBtn.classList.remove('listening');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                handleSend();
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                micBtn.classList.remove('listening');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                alert('Voice input failed: ' + event.error);
            };
            
            recognition.onend = () => {
                micBtn.classList.remove('listening');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            };
        }

        // --- Project Management ---
        function addProject() {
            const name = document.getElementById('new-name').value.trim();
            const persona = document.getElementById('new-persona').value.trim();
            const rules = document.getElementById('new-rules').value.trim();
            
            if (!name) {
                alert('Please enter a project name');
                return;
            }
            
            const id = 'p' + Date.now();
            db.projects[id] = { 
                name, 
                persona: persona || 'Helpful AI assistant',
                rules: rules || 'Be helpful and informative',
                memory: '', 
                messages: [],
                created: new Date().toISOString()
            };
            
            db.activeId = id;
            save(); 
            closeAll(); 
            init();
            
            // Clear form
            document.getElementById('new-name').value = '';
            document.getElementById('new-persona').value = '';
            document.getElementById('new-rules').value = '';
            
            showNotification(`Project "${name}" created!`, 'success');
        }

        // Real-time Project Deletion
        function deleteProject(id) {
            if (Object.keys(db.projects).length <= 1) {
                alert('You must have at least one project.');
                return;
            }
            
            const projectName = db.projects[id].name;
            
            if (confirm(`Delete project "${projectName}"? This cannot be undone.`)) {
                // 1. Database se delete
                delete db.projects[id];
                
                // 2. Agar active project delete ho raha hai, to dusra select karo
                if (db.activeId === id) {
                    const remainingIds = Object.keys(db.projects);
                    db.activeId = remainingIds[0];
                }
                
                // 3. Save to localStorage
                save();
                
                // 4. UI ko INSTANTLY update WITHOUT refresh
                renderTabs();
                renderMessages();
                
                // 5. Agar project overlay open hai, to list bhi update karo
                if (document.getElementById('project-overlay').classList.contains('active')) {
                    renderProjectList();
                }
                
                // 6. Notification show karo
                showNotification(`Project "${projectName}" deleted successfully`, 'success');
                
                // 7. Sound play karo
                playSound('beep');
            }
        }

        // Switch project without closing overlay
        function switchToProject(id) {
            db.activeId = id;
            save();
            
            // Update UI
            renderTabs();
            renderMessages();
            renderProjectList(); // Refresh project list to show new active state
            
            showNotification(`Switched to: ${db.projects[id].name}`, 'success');
            playSound('beep');
        }

        // Edit project
        function editProject(id) {
            const proj = db.projects[id];
            
            // Fill edit form
            document.getElementById('new-name').value = proj.name;
            document.getElementById('new-persona').value = proj.persona;
            document.getElementById('new-rules').value = proj.rules;
            
            // Show confirmation for update
            if (confirm(`Update project "${proj.name}"?`)) {
                // Get updated values
                const newName = document.getElementById('new-name').value.trim();
                const newPersona = document.getElementById('new-persona').value.trim();
                const newRules = document.getElementById('new-rules').value.trim();
                
                if (newName) {
                    db.projects[id].name = newName;
                    db.projects[id].persona = newPersona;
                    db.projects[id].rules = newRules;
                    save();
                    
                    // Clear form
                    document.getElementById('new-name').value = '';
                    document.getElementById('new-persona').value = '';
                    document.getElementById('new-rules').value = '';
                    
                    // Update UI
                    renderTabs();
                    renderProjectList();
                    
                    showNotification(`Project "${newName}" updated!`, 'success');
                }
            }
        }

        // Render Project List
        function renderProjectList() {
            const list = document.getElementById('project-list-render');
            if (!list) return;
            
            list.innerHTML = '<h2 style="margin: 20px 0 15px; color: var(--neon-blue);">YOUR PROJECTS</h2>';
            
            if (Object.keys(db.projects).length === 0) {
                list.innerHTML += `
                    <div class="neon-card" style="text-align: center; padding: 30px;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--neon-blue); margin-bottom: 15px;"></i>
                        <h3 style="color: var(--neon-pink);">No Projects Yet</h3>
                        <p style="color: #aaa;">Create your first project using the form above!</p>
                    </div>
                `;
                return;
            }
            
            for (let id in db.projects) {
                const proj = db.projects[id];
                const date = new Date(proj.created).toLocaleDateString();
                const msgCount = proj.messages.length;
                const isActive = db.activeId === id;
                
                // Better HTML with inline event handlers
                const projectCard = document.createElement('div');
                projectCard.className = `project-card ${isActive ? 'active-project' : ''}`;
                projectCard.style.cssText = isActive ? 'border-color: var(--neon-blue); background: rgba(0, 212, 255, 0.05);' : '';
                projectCard.innerHTML = `
                    <div class="project-info">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            ${proj.name}
                            ${isActive ? '<span class="status-light" style="background: var(--neon-green);"></span><span style="color: var(--neon-green); font-size: 12px;">(Active)</span>' : ''}
                        </h3>
                        <p style="color: #aaa; font-size: 14px;">
                            <i class="fas fa-user"></i> ${proj.persona.substring(0, 50)}${proj.persona.length > 50 ? '...' : ''} ‚Ä¢ 
                            <i class="fas fa-message"></i> ${msgCount} messages ‚Ä¢ 
                            <i class="fas fa-calendar"></i> ${date}
                        </p>
                        ${proj.memory ? `<p style="color: #888; font-size: 12px; margin-top: 5px;"><i class="fas fa-brain"></i> ${proj.memory.substring(0, 80)}${proj.memory.length > 80 ? '...' : ''}</p>` : ''}
                    </div>
                    <div class="project-actions" style="display: flex; gap: 10px;">
                        <button class="circle-btn" onclick="switchToProject('${id}')" title="Switch to this project" style="width: 40px; height: 40px; background: var(--neon-blue);">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="circle-btn" onclick="editProject('${id}')" title="Edit project" style="width: 40px; height: 40px; background: var(--neon-yellow);">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="circle-btn" onclick="deleteProject('${id}')" title="Delete project" style="width: 40px; height: 40px; background: var(--neon-red);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                list.appendChild(projectCard);
            }
        }

        // --- Model Selection Functions ---
        function updateModelInput() {
            const select = document.getElementById('model-select');
            const input = document.getElementById('model-id');
            
            if (select.value === 'custom') {
                input.disabled = false;
                input.placeholder = 'Enter custom model ID...';
                input.value = '';
                input.focus();
            } else if (select.value) {
                input.value = select.value;
                input.disabled = true;
            }
        }

        function loadModelSettings() {
            const input = document.getElementById('model-id');
            const select = document.getElementById('model-select');
            
            if (db.model) {
                input.value = db.model;
                
                // Try to find in dropdown
                for (let option of select.options) {
                    if (option.value === db.model) {
                        select.value = db.model;
                        input.disabled = true;
                        return;
                    }
                }
                
                // If not found in dropdown, set to custom
                select.value = 'custom';
                input.disabled = false;
            }
        }

        // --- Utility Functions ---
        function copyText(idx) {
            const text = db.projects[db.activeId].messages[idx].content;
            navigator.clipboard.writeText(text).then(() => {
                // Show visual feedback
                const toolBtn = event.target.closest('.tool-btn');
                if (toolBtn) {
                    const original = toolBtn.innerHTML;
                    toolBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    toolBtn.style.color = 'var(--neon-green)';
                    
                    setTimeout(() => {
                        toolBtn.innerHTML = original;
                        toolBtn.style.color = '';
                    }, 2000);
                }
            });
        }

        function deleteMsg(idx) {
            if (confirm('Delete this message?')) {
                db.projects[db.activeId].messages.splice(idx, 1);
                save(); 
                renderMessages();
                showNotification('Message deleted', 'warning');
            }
        }

        function generateNewUserKey() {
            if (confirm("Create a new Personal User Key? Your old identity will be replaced.")) {
                db.userKey = 'AIT-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                document.getElementById('user-key-display').innerText = db.userKey;
                save();
                
                // Show confirmation
                showNotification(`New User Key Generated: ${db.userKey}`, 'success');
            }
        }

        // Input Auto-resize
        function setupInput() {
            const tx = document.getElementById('user-input');
            tx.addEventListener("input", function() {
                this.style.height = "auto";
                this.style.height = (this.scrollHeight) + "px";
            });
            
            // Enter to send (Shift+Enter for new line)
            tx.addEventListener("keydown", function(e) {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
        }

        function resetInputHeight() {
            const tx = document.getElementById('user-input');
            tx.style.height = "auto";
        }

        // Overlay Functions
        function openOverlay(id) { 
            document.getElementById(id).classList.add('active'); 
            if (id === 'project-overlay') {
                setTimeout(renderProjectList, 100);
            }
            if (id === 'settings-overlay') {
                document.getElementById('api-key').value = db.apiKey || '';
                loadModelSettings();
            }
        }

        function closeAll() { 
            document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active')); 
        }

        function saveSettings() {
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-id').value.trim();
            const autoSpeak = document.getElementById('auto-speak').checked;
            
            db.apiKey = apiKey;
            db.model = model || 'google/gemini-2.0-flash-exp:free';
            db.autoSpeak = autoSpeak;
            
            save(); 
            checkApiStatus(); 
            closeAll();
            
            // Show success message
            if (apiKey) {
                const beep = document.getElementById('snd-beep');
                beep.currentTime = 0;
                beep.play().catch(() => {});
                
                // Show notification
                setTimeout(() => {
                    showNotification(`Settings saved! Model: ${db.model}`, 'success');
                    location.reload();
                }, 300);
            }
        }

        // Emergency Delete Function
        function emergencyDelete(projectName) {
            for (let id in db.projects) {
                if (db.projects[id].name === projectName) {
                    delete db.projects[id];
                    save();
                    showNotification(`Project "${projectName}" deleted!`, 'success');
                    location.reload();
                    return;
                }
            }
            showNotification('Project not found!', 'error');
        }

        // Bulk Delete Projects
        function bulkDeleteProjects() {
            const projectNames = Object.values(db.projects).map(p => p.name);
            
            const toDelete = prompt(`Enter project names to delete (comma-separated):\n\nAvailable: ${projectNames.join(', ')}`);
            
            if (!toDelete) return;
            
            const namesToDelete = toDelete.split(',').map(n => n.trim());
            let deletedCount = 0;
            
            for (let id in db.projects) {
                if (namesToDelete.includes(db.projects[id].name)) {
                    delete db.projects[id];
                    deletedCount++;
                }
            }
            
            if (deletedCount > 0) {
                save();
                showNotification(`Deleted ${deletedCount} projects`, 'success');
                // Update UI
                renderTabs();
                renderProjectList();
                renderMessages();
            } else {
                showNotification('No projects were deleted', 'warning');
            }
        }

        // Initialize on load
        window.onload = init;
        
        // Clean up speech synthesis on page unload
        window.addEventListener('beforeunload', function() {
            if (currentSpeech.isSpeaking) {
                window.speechSynthesis.cancel();
            }
        });
    </script>
</body>
</html>